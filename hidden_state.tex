\documentclass{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath}
\pagestyle{empty}
\begin{document}

Consider an alphabet of symbols \{A,C\}, and an ordered configuration
from this alphabet. Each symbol is read using a process that miscalls
it with some error probability e.  We don't observe the actual
configuration; it is hidden.  The observed configuration is produced
from the hidden one through this calling process.  Formally:

\begin{align*}
h & \equiv \text{the hidden configuration} \\
o & \equiv \text{the observed configuration} \\
h[i] & \equiv \text{the i'th element of } h \\
h_A & \equiv \text{the number of A elements in } h \text{, }
= \sum_i \delta(h[i],A) \\
\text{with }\delta(p,q) & \equiv
\begin{cases}
  p = q & 1 \\
  p \neq q & 0
\end{cases}
\text{ and }
\bar{\delta}(p,q) \equiv
\begin{cases}
  p = q & 0 \\
  p \neq q & 1
\end{cases}
\end{align*}

We are interested in the likelihood of an observed configuration
arising from a hidden configuration.  This is specified in the usual
way as:

\begin{align}
  Pr(o,h;e) & \equiv Pr(o|h;e)Prior(h;\alpha) \\[2ex]
  Dist(o,h) & \equiv \sum_i \bar{\delta}(o[i],h[i]) \\[2ex]
  Pr(o|h;e) & \equiv e^{Dist(o,h)}(1-e)^{D-Dist(o,h)} \\[2ex]
  Path(L;e) & \equiv Pr(o|h;e) \text{ s.t. } Dist(o,h) = L\\[2ex]
  Pr(h|o;e) & \propto Pr(o,h;e) \nonumber
\end{align}

$Dist(o,h)$ is the number of elements that differ between $o$ and $h$.
$Pr(o|h;e)$ gives the probability of 'generating', or calling a
configuration $o$ from a configuration $h$ when a certain error
probability $e$ is in effect. We will later be interested in grouping
equal terms together, so the expression $Path(L;e)$ can be substituted
for $Pr(o|h;e)$ to make this equivalence explicit.

$Prior(h;\alpha)$ mentioned above hasn't been specified yet.  We
choose a prior to represent the process of founder base generation,
namely a two-stage model.  First, some symbol composition $H$ is
chosen from a Dirichlet distribution.  The Dirichlet is parameterized
by $\alpha$, and it is meant to represent the possible base
compositions of samples that might be sequenced.  Once a sample is
chosen, the individual founder bases (elements of $h$) are
independently drawn with replacement, from the composition $H$.  We
use replacement since the actual physical sample is so large that it
may as well be. This design gives rise to a distribution known as
multinomial-dirichlet, with the following form:

\begin{align}
Prior(h;\alpha) & \equiv \int_p{Dir(p;\alpha) Pr(h|p)dp}
= \frac{\Gamma(A)}{\Gamma(D+A)}
\prod_k \frac{\Gamma(h_k+\alpha_k)}{\Gamma(\alpha_k)} \\[2ex]
\text{with } A & \equiv \sum_k \alpha_k \text{ and } D \equiv \sum_k h_k \nonumber \\[2ex]
PriorComp(H;\alpha) & \equiv Prior(h;\alpha) \text{ for some } h \text{ s.t. } h_A = H_A, h_C = H_C
\end{align}

Like $Path(L;e)$ above, $PriorComp(H;\alpha)$ is also a notational
convenience that makes explicit the dependence only on $H$ derived
from $h$ and not $h$'s specific element ordering.

Now, ultimately we are interested in the likelihood of the set of
configurations $h$ having a particular symbol composition. Let
$S_{H,o,L}$ be the set of configurations $h$ where $(h_A,h_C) = H$ and
$Dist(h, o) = L$.

With the alphabet of two symbols \{A, C\}, there are types of changes
between $o$ and $h$, which we can depict with the contingency table:

\begin{align*}
  & \begin{matrix}
    n_{AA} & n_{AC} & H_A \\
    n_{CA} & n_{CC} & H_C \\
    o_A & o_C & D
  \end{matrix} \\[2ex]
  \text{with }
  n_{pq} & \equiv \text{number of elements where } (h[i],o[i]) = (p,q) \\
  & = \sum_{i}^{D} \delta(h[i],p) \delta(o[i],q)
\end{align*}

with row and column sums shown.  We write the equations in terms of
the marginals $(H_A, H_C)$, $(o_A, o_C)$ plus $n_{AA}$. All other
matrix cells can be derived from these.

\begin{align*}
  v & \equiv n_{AA} & \text{number of overlapping 'A' elements} \\
  L & \equiv n_{AC} + n_{CA} & \text{number of differing elements} \nonumber \\
  & = H_A + o_A - 2v \\
  \bar{v} & \equiv n_{CC} = D - L - v & \text{number of overlapping 'C' elements} \\
  & = D - H_A - o_A + v
\end{align*}

It works out that

\begin{align}
  |S_{H,o,L}| & = {o_A \choose v} {o_C \choose \bar{v}}
\end{align}

As it turns out, every configuration $h \in S_{H,o,L}$ gives the same
value for $Pr(h, o; e)$.  This is because components $Prior(h;\alpha)$
depends only on $(h_A,h_C)$ (not on the specific permutation of the
elements of $h$), and $Pr(o|h;e)$ depends only on $Dist(h,o) = L$. We
can then write:

\begin{align}
  Posterior(H,o,L;e) & \equiv Pr(h \in S_{H,o,L},o;e) \nonumber \\[2ex]
  & = |S_{H,o,L}| Pr(h,o;e) \nonumber \\[2ex]
  & = |S_{H,o,L}| Path(L;e) PriorComp(H;\alpha) \nonumber \\[2ex]
  & = {o_A \choose v}{o_C \choose \bar{v}}
  e^L(1-e)^{D-L}
  \frac{\Gamma(A)}{\Gamma(D+A)}
  \prod_k \frac{\Gamma(H_k+\alpha_k)}{\Gamma(\alpha_k)}
\end{align}


We are interested ultimately in computing

\begin{align}
  Posterior(H,o;e) & \equiv \sum_L Posterior(H,o,L;e) \nonumber \\
\end{align}




Consider a heuristic way to evaluate $Posterior(H,o;e)$. With a
2-symbol alphabet \{A, C\}, L can take on values (0,2,4,...) or
(1,3,5,...) for a given choice of $o$ and $H$. For each value of $L$,
the components of $Posterior(H,o,L;e)$ differ from each other in
$|S_{H,o,L}|$ and $Path(L;e)$ but not in $PriorComp(H;\alpha)$.  Now
consider the change in these two factors when $L$ increases by 2
(thus, $v$ decreases by one, represented by $\check{v} = v - 1$):

\begin{align}
  \frac{|S_{H,o,L+2}|}{|S_{H,o,L}|}
  & \equiv
  \frac{{o_A \choose {v-1}}}{{o_A \choose v}}
  \frac{{o_C \choose {\bar{v}+1}}}{{o_C \choose {\bar{v}}}}
  = &
  \frac{v}{o_A-(v-1)}
  \frac{o_C - \bar{v}}{\bar{v} + 1} \\[4ex]
  \frac{Path(L+2;e)}{Path(L;e)}
  & \equiv
  \frac{e^{L+2}(1-e)^{D-(L+2)}}{e^L(1-e)^{D-L}}
  = &
  \frac{e^2}{(1-e)^2}
\end{align}

So we see that the Path component decreases sharply.  The highest
error probabilities we will be considering are likely about $0.05$;
the Path factor change for this will be $0.002506$. The set size
$|S_{H,o,L}|$ increases depending on $v$ and $D$ mostly. We would like
to characterize the shape of the product of those two ratios as a
function of L, and find the value of L that gives a 99.9\% quantile
(or some high value).  For many settings of $(o_A, o_C)$ and $(h_A,
h_C)$, the 99.9\% quantile will be found for a low value of L.  This
is fortunate because it means we can approximate:

\begin{align}
  Posterior(H,o;e) \approx \sum_{L=L_{min}}^{L_{max}} Posterior(H,o,L;e)
\end{align}

The next step is to identify the subset of $H$ that comprise a
majority of the mass of $Posterior(H,o;e)$ seen as a function of
$H$. Holding the overlap value $v$ fixed, define $\hat{H} \equiv (H_A
+ 1, H_C -1)$.  Given this scenario, $H_A$ can vary from $v$ to $o_C +
v - 1$. Note that by varying $H$ in this way and holding $v$ fixed,
$L$ increases by one.

We expect that it is a unimodal function of $H$ ($H_A$ or $H_C$), and
use a ratio technique as follows.  Given a function $F()$ defined over
a discreet domain of values [0,1,2,...,n], find some value j such that
$\frac{F(i)}{F(i-1)} > 1 \forall i <= j$ and $\frac{F(i)}{F(i-1)} <
1 \forall i > j$.  Then, j is a global maximum. In the following, our
$F()$ is $Posterior(H,o,L;e)$ and the implicit discrete variable is
$H_A$.

\begin{align}
  \frac{Posterior(H,o,L;e)}{Posterior(\hat{H},o,L+1;e)} & =
  \frac{|S_{\hat{H},o,L+1}|}{|S_{H,o,L}|}
  \frac{Path(L+1)}{Path(L)}
  \frac{PriorComp(\hat{H})}{PriorComp(H)} \nonumber  
\end{align}

with

\begin{align}
  \frac{|S_{\hat{H},o,L+1}|}{|S_{H,o,L}|}
  & \equiv
  \frac{{o_A \choose v}}{{o_A \choose v}}
  \frac{{o_C \choose {\bar{v}-1}}}{{o_C \choose \bar{v}}}
  =
  \frac{\bar{v}}{o_C - (\bar{v} - 1)} \\[3ex]
  \frac{Path(L+1)}{Path(L)}
  & =
  \frac{e}{1 - e} \\[3ex]
  \frac{PriorComp(\hat{H};\alpha)}{PriorComp(H;\alpha)} & =
  \frac{\frac{\Gamma(A)}{\Gamma(N+A)}}{\frac{\Gamma(A)}{\Gamma(N+A)}}
  \frac{ \frac{\Gamma(H_A+1+\alpha_A)}{\Gamma(\alpha_A)}}{
    \frac{\Gamma(H_A+\alpha_A)}{\Gamma(\alpha_A)} } \frac{
    \frac{\Gamma(H_C-1+\alpha_C)}{\Gamma(\alpha_C)} }{
    \frac{\Gamma(H_C+\alpha_C)}{\Gamma(\alpha_C)} } \nonumber \\[2ex]
  & =
  \frac{\Gamma(H_A + 1 + \alpha_A)}{\Gamma(H_A + \alpha_A)}
  \frac{\Gamma(H_C - 1 + \alpha_C)}{\Gamma(H_C + \alpha_C)} \nonumber \\[2ex]
  & =
  \frac{H_A + 1 + \alpha_A}{H_C + \alpha_C}
\end{align}

So we see that the $PriorComp()$ ratio term is the only term that
varies with respect to $H_A$ and it is monotonically increasing with
$H_A$.  So with binary search, it is trivial to find the value.


\end{document}
